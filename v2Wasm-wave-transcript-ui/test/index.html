<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transcription Player with WASM</title>
    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/6.6.3/wavesurfer.min.js"></script>
    <style>
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #ddd;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        input[type="range"]:hover {
            opacity: 1;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #4CAF50;
            cursor: pointer;
            border-radius: 50%;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #4CAF50;
            cursor: pointer;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="waveform"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const speakerColors = [
            'bg-red-500', 'bg-blue-500'
        ];

        const TranscriptionPlayer = () => {
            const [transcript, setTranscript] = useState(null);
            const [currentTime, setCurrentTime] = useState(0);
            const [isPlaying, setIsPlaying] = useState(false);
            const [duration, setDuration] = useState(0);
            const wavesurferRef = useRef(null);

            useEffect(() => {
                // Load transcript
                fetch('transcript.json')
                    .then(response => response.json())
                    .then(data => {
                        setTranscript(data);
                        setDuration(data.metadata.duration);
                    });

                // Initialize WaveSurfer
                wavesurferRef.current = WaveSurfer.create({
                    container: '#waveform',
                    waveColor: 'violet',
                    progressColor: 'purple',
                    responsive: true,
                    height: 100,
                });

                wavesurferRef.current.load('audio.wav');

                wavesurferRef.current.on('audioprocess', function(time) {
                    setCurrentTime(time);
                });

                wavesurferRef.current.on('ready', function() {
                    setDuration(wavesurferRef.current.getDuration());
                });

                return () => {
                    wavesurferRef.current.destroy();
                };
            }, []);

            const handlePlayPause = () => {
                if (wavesurferRef.current.isPlaying()) {
                    wavesurferRef.current.pause();
                    setIsPlaying(false);
                } else {
                    wavesurferRef.current.play();
                    setIsPlaying(true);
                }
            };

            const handleSliderChange = (e) => {
                const newTime = parseFloat(e.target.value);
                wavesurferRef.current.seekTo(newTime / duration);
                setCurrentTime(newTime);
            };

            const formatTime = (time) => {
                const minutes = Math.floor(time / 60);
                const seconds = Math.floor(time % 60);
                return `${minutes}:${seconds.toString().padStart(2, '0')}`;
            };

            const SpeakerTimeline = ({ speaker, color }) => (
                <div className="mb-2">
                    <div className="flex items-center mb-1">
                        <div className={`w-4 h-4 ${color} rounded-full mr-2`}></div>
                        <span>{speaker}</span>
                    </div>
                    <div className="relative h-8 bg-gray-200 rounded">
                        {transcript && transcript.segments
                            .filter(item => item.speaker === speaker)
                            .map((item, index) => (
                                <div
                                    key={index}
                                    className={`absolute h-full ${color}`}
                                    style={{
                                        left: `${(item.start / duration) * 100}%`,
                                        width: `${((item.end - item.start) / duration) * 100}%`,
                                    }}
                                />
                            ))}
                    </div>
                </div>
            );

            return (
                <div className="max-w-4xl mx-auto p-6 bg-white rounded-lg shadow-lg">
                    <div className="mb-4">
                        <input
                            type="range"
                            min="0"
                            max={duration}
                            value={currentTime}
                            onChange={handleSliderChange}
                            className="w-full"
                            step="0.1"
                        />
                        <div className="flex justify-between text-sm text-gray-500 mt-1">
                            <span>{formatTime(currentTime)}</span>
                            <span>{formatTime(duration)}</span>
                        </div>
                    </div>

                    <div className="mb-4 flex justify-center">
                        <button 
                            onClick={handlePlayPause}
                            className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                        >
                            {isPlaying ? 'Pause' : 'Play'}
                        </button>
                    </div>

                    <div className="mb-4">
                        <h3 className="font-bold mb-2">Transcript:</h3>
                        <div className="bg-gray-100 p-4 rounded-lg max-h-60 overflow-y-auto">
                            {transcript && transcript.segments.map((item, index) => (
                                <p 
                                    key={index} 
                                    className={`mb-2 p-1 rounded ${
                                        currentTime >= item.start && currentTime < item.end ? 'bg-yellow-200' : ''
                                    }`}
                                >
                                    <span className="font-bold">{item.speaker}: </span>
                                    {item.text}
                                </p>
                            ))}
                        </div>
                    </div>

                    <div>
                        <h3 className="font-bold mb-2">Speaker Timelines:</h3>
                        {transcript && transcript.metadata.speakers.map((speaker, index) => (
                            <SpeakerTimeline 
                                key={speaker} 
                                speaker={speaker} 
                                color={speakerColors[index % speakerColors.length]} 
                            />
                        ))}
                        <div className="relative h-1 bg-red-500 mt-2" style={{ left: `${(currentTime / duration) * 100}%` }}></div>
                        <div className="flex justify-between text-sm text-gray-500 mt-1">
                            <span>{formatTime(0)}</span>
                            <span>{formatTime(duration)}</span>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            return (
                <div className="container mx-auto mt-10">
                    <h1 className="text-3xl font-bold mb-6 text-black">Transcription Player Demo</h1>
                    <TranscriptionPlayer />
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
